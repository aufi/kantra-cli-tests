name: CLI container-less on Linux

inputs:
  tag:
    description: |
      Tag release
    required: false
    type: string
    default: latest
  tier:
    description: |
      Test TIER name
    required: false
    type: string
    default: TIER0

runs:
  using: "composite"
  steps:
  - uses: actions/checkout@v4
  - uses: actions/setup-java@v4
    with:
      distribution: 'microsoft'
      java-version: '21'
  - run: java --version
    shell: bash
  - name: Set up Igor's kantra installer
    shell: bash
    run: |
      #git clone https://github.com/ibragins/konveyor-cli-deployment.git
      #cd konveyor-cli-deployment
      #pip install -r requirements.txt
      #echo '{"misc_downstream_path": "","temp_dir": "","extract_binary": "","get_images_output": "","bundle": "","no_brew": "","ssh_user": "","ssh_key": ""}' >> config.json
      ## Workaround ruleset home (?)
      #mkdir -p /home/runner/.config
      #./install_cli.py --upstream true
      #cd ..
      #chmod +x /home/runner/.kantra/kantra
      #/home/runner/.kantra/kantra --help

  - name: Extract kantra
    shell: bash
    run: |
      export KANTRA_DIR=/home/runner/.kantra
      mkdir $KANTRA_DIR
      docker create --name kantra-download quay.io/konveyor/kantra:${{ inputs.tag }}
      docker cp kantra-download:/usr/local/bin/kantra $KANTRA_DIR/kantra
      docker cp kantra-download:/jdtls $KANTRA_DIR/jdtls
      docker cp kantra-download:/bin/fernflower.jar $KANTRA_DIR/fernflower.jar
      docker cp kantra-download:/usr/local/static-report $KANTRA_DIR/static-report
      docker cp kantra-download:/opt/rulesets $KANTRA_DIR/rulesets
      docker cp kantra-download:/usr/local/etc/maven.default.index $KANTRA_DIR/maven.default.index
      ls -l $KANTRA_DIR
      chmod +x /home/runner/.kantra/kantra
      /home/runner/.kantra/kantra --help

  - name: Configure Test Environment Variables
    shell: bash
    run: |
      cp .env.example .env
      mkdir ${{ github.workspace }}/report
      
      > .env
      echo "export KANTRA_CLI_PATH=/home/runner/.kantra/kantra" >> .env
      echo "export REPORT_OUTPUT_PATH=${{ github.workspace }}/report" >> .env
      echo "export PROJECT_PATH=${{ github.workspace }}" >> .env
      
      cat .env
      # Set test tier to ENV variable (could be changed)
      export ${{ inputs.tier }}=1
    working-directory: ${{ github.workspace }}
  - name: Install test dependencies
    shell: bash
    run: |
      python -m pip install --upgrade pip
      pip install -r requirements.txt

  - name: Run TIER0 analysis test
    shell: bash
    run: |
      . ${{ github.workspace }}/.env
      pytest -s tests/analysis/java/test_tier0.py

  - name: Save analysis output
    uses: actions/upload-artifact@v4
    if: always()
    with:
      name: kantra-outputs-linux-containerless
      path: ${{ github.workspace }}/report
